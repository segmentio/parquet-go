//go:build !purego

#include "textflag.h"

// validateByteArrays is implemented in assembly because it is the bottleneck in
// many cases when encoding byte arrays. This version of the function yields
// ~50% better throughput than the code generated by the Go compiler.
//
// func validateByteArrays([]byte) status
TEXT Â·validateByteArrays(SB), NOSPLIT, $0-32
    MOVQ arg_base+0(FP), AX
    MOVQ arg_len+8(FP), BX

    CMPQ BX, $0
    JE done

    XORQ SI, SI
loop:
    MOVQ BX, CX
    SUBQ SI, CX
    CMPQ CX, $4
    JB errTooShort

    MOVLQZX (AX)(SI*1), DX
    ADDQ $4, SI
    SUBQ $4, CX
    CMPQ DX, CX
    JA errTooShort
    CMPQ DX, $0x7FFFFFFF
    JA errTooLarge

    ADDQ DX, SI
    CMPQ SI, BX
    JNE loop
done:
    MOVQ $0, CX
    MOVQ CX, ret+24(FP)
    RET
errTooShort:
    MOVQ $1, CX
    MOVQ CX, ret+24(FP)
    RET
errTooLarge:
    MOVQ $2, CX
    MOVQ CX, ret+24(FP)
    RET
